/*! auth - v1.4 - 2013-05-27 11:18:25 AM
* Copyright (c) 2013 zhangting(Harry Chen); Licensed  */
KISSY.add("gallery/auth/1.4/lib/rule/base",function(a,b){var c="success",d="error",e={success:"",error:""},f=function(){var b=[].slice.call(arguments),c=this;c.validation=b[0]?b[0]:function(){return!0};var d=a.merge({},b[1]);b[1]&&(c._args=a.isArray(d.args)?d.args:[d.args]),a.isPlainObject(d.msg)||(d.msg={error:d.msg}),c._msg=a.merge(e,d.msg),f.superclass.constructor.call(c)};return a.extend(f,b,{validate:function(){var a,b=this,e=[].slice.call(arguments),f=b.validation.apply(b,e.length?e:b._args);return a=b._msg?f?b._msg[c]:b._msg[d]:f?b._msg[c]:"",b.fire("beforeValidate"),b.fire(f?c:d,{msg:a}),b.fire("validate",{result:f,msg:a,name:b._name}),b.fire("afterValidate"),f}},{ATTRS:{msg:{value:"",setter:function(b){this._msg=a.merge(this._msg,b)}}}}),f},{requires:["base"]}),KISSY.add("gallery/auth/1.4/lib/utils",function(S,DOM,undefined){var Utils={toJSON:function(cfg){cfg=cfg.replace(/'/g,'"');try{eval("cfg="+cfg)}catch(e){S.log("data-valid json is invalid")}return cfg},guid:function(){return"AUTH_"+S.guid()},getEvent:function(a){var b="blur",c=DOM.attr(a,"type");switch(c){case"select-multiple":case"radio":case"checkbox":b="click";break;default:b="blur"}return b},getValue:function(a){var b=[],c=DOM.attr(a,"type");switch(c){case"select-multiple":S.each(a.options,function(a){a.selected&&b.push(a.value)});break;case"radio":case"checkbox":S.each(a,function(a){a.checked&&b.push(a.value)});break;default:b=DOM.val(a)}return b}};return Utils},{requires:["dom"]}),KISSY.add("gallery/auth/1.4/lib/rule/html/propertyRule",function(a,b,c){var d=function(){var b=this,c=[].slice.call(arguments);if(!c.length)return a.log("please use a name to define property"),void 0;b._name=c[0];var e=c[2]||{args:[]};b._initArgs=e.args,b._propertyValue=e.propertyValue,b._el=e.el,d.superclass.constructor.apply(b,c.slice(1))};return a.extend(d,b,{validate:function(){var b=this;if(a.isUndefined(arguments[0]))return d.superclass.validate.apply(this,[b._propertyValue,c.getValue(b._el)].concat(b._initArgs));var e=[].slice.call(arguments);return b._initArgs=e,d.superclass.validate.apply(this,[b._propertyValue,c.getValue(b._el)].concat(e))}}),d},{requires:["../base","../../utils"]}),KISSY.add("gallery/auth/1.4/lib/rule/rule",function(a,b,c){var d=function(){var b=this,c=[].slice.call(arguments);if(!c.length)return a.log("please use a name to define rule"),void 0;b._name=c[0];var e=c[2]||{args:[]};b._initArgs=e.args,b._el=e.el,d.superclass.constructor.apply(b,c.slice(1))};return a.extend(d,b,{validate:function(){var b=this;if(a.isUndefined(arguments[0]))return d.superclass.validate.apply(this,[c.getValue(b._el)].concat(b._initArgs));var e=[].slice.call(arguments);return b._initArgs=e,d.superclass.validate.apply(this,[c.getValue(b._el)].concat(e))}}),d},{requires:["./base","../utils"]}),KISSY.add("gallery/auth/1.4/lib/rule/ruleFactory",function(a,b,c,d,e){var f=function(){var a=this;f.superclass.constructor.call(a)};return f.rules={},a.mix(f.rules,{required:function(b,c){return a.isArray(c)?c.length>0:!!c},pattern:function(a,b){return new RegExp(a).test(b)},max:function(b,c){return a.isNumber(c)?b>=c:!1},min:function(b,c){return a.isNumber(c)?c>=b:!1},step:function(b,c){return a.isNumber(c)?0==c||1==b?!0:c%b:!1},equalTo:function(b,c){return a.isNumber(c)?b===c:a.one(b)?a.one(b).val()===c:b===c}}),a.mix(f,{HTML_PROPERTY:["required","pattern","max","min","step","equalTo"],register:function(a,b){f.rules[a]=b},create:function(b,g){return a.inArray(b,f.HTML_PROPERTY)?new c(b,f.rules[b],g):f.rules[b]?new d(b,f.rules[b],g):e}}),f},{requires:["base","./html/propertyRule","./rule"]}),KISSY.add("gallery/auth/1.4/lib/msg/base",function(a,b){var c="kf-msg",d=function(a,b){var c=this;c._init(a,b),d.superclass.constructor.call(c)};return a.extend(d,b,{_init:function(b,d){var e=this;e._el=a.one(b),e.set("tpl",d.tpl),e.set("args",d.args),e._msgContainer=a.one("."+c,e._el.parent()),e._msgContainer||(e._msgContainer=a.one('<div class="'+c+'" style="display: none"></div>'),e._el.parent().append(e._msgContainer))},hide:function(){this._msgContainer.hide()},show:function(b){var c=this;b=a.merge(c.get("args"),b),a.buffer(function(){c._msgContainer.html(a.substitute(c.get("tpl"),b)),c._msgContainer.show()},50)()}},{ATTRS:{tpl:{value:""},args:{value:{}}}}),d},{requires:["base"]}),KISSY.add("gallery/auth/1.4/lib/field/field",function(a,b,c,d,e,f,g,h,i,j){var k="",l="data-valid",m={event:"blur",style:{success:"ok",error:"error"}},n=function(b,c){var d=this;if(d._validateDone={},d._cache={},b&&e.attr(b,l)){var f=e.attr(b,l);f=j.toJSON(f);var g={rules:f};c=a.merge(g,c)}return c=a.merge(m,c),d._cfg=c||{},d._storage={},d._init(b),n.superclass.constructor.call(d),d};return a.extend(n,c,{_init:function(c){var d=this,e=d._cfg,g=a.one(c),h=a.merge({},e.rules);if(a.inArray(g.attr("type"),["checkbox","radio"])){var l=g.getDOMNode().form,m=g.attr("name"),n=[];a.each(document.getElementsByName(m),function(a){a.form==l&&n.push(a)}),d.set("el",n)}else d.set("el",c);var o=function(){d.fire("afterFieldValidation")};if(d._cfg.msg){d._msg=new i(g,d._cfg.msg);var p=d._cfg.style;d.on("afterRulesValidate",function(a){var b=a.result,c=a.curRule,e=d._cache[c].msg||k;(d.get("result")!==b||d.get("msg")!==e)&&(e?d._msg.show({style:b?p.success:p.error,msg:e}):d._msg.hide())})}d.on("afterRulesValidate",function(a){var b=a.result,c=a.curRule,e=d._cache[c].msg||k;d.set("result",b),d.set("message",e),d.fire("validate",{result:b,msg:e,errRule:b?"":c}),d.fire("afterValidate"),o()}),a.each(f.HTML_PROPERTY,function(a){if(g.hasAttr(a)){var b=f.create(a,{propertyValue:g.attr(a),el:d.get("el"),msg:h[a]});d.add(a,b)}}),a.each(h,function(a,b){if(!d._storage[b]&&f.rules[b]){var c=f.create(b,{el:d.get("el"),msg:a});d.add(b,c)}}),"none"!=e.event&&b.on(d.get("el"),e.event||j.getEvent(g),function(){d.validate()})},add:function(b,c){var d=this,e=d._storage;return c instanceof h||c instanceof g?e[b]=c:a.isFunction(c)&&(e[b]=new g(b,c,{el:d._el})),e[b]&&e[b].on("validate",function(b){a.log("[after rule validate]: name:"+b.name+",result:"+b.result+",msg:"+b.msg),d._cache[b.name].result=b.result,d._cache[b.name].msg=b.msg}),this._cache[b]={},d},remove:function(a){var b=this._storage;return delete b[a],delete this._cache[a],this},validate:function(a,b){var c=!0,d=this,e=d._storage,b=b||{},f=k;if(a)e[a]&&(d.fire("beforeValidate"),c=e[a].validate(b.args),f=a);else{d.fire("beforeValidate");for(var g in e)if(f=g,!e[g].validate(b.args)){c=!1;break}}return f&&d.fire("afterRulesValidate",{result:c,curRule:f}),c}},{ATTRS:{message:{value:k},result:{},el:{}}}),n},{requires:["event","base","json","dom","../rule/ruleFactory","../rule/rule","../rule/html/propertyRule","../msg/base","../utils"]}),KISSY.add("gallery/auth/1.4/lib/base",function(a,b,c,d,e,f){var g={autoBind:!0,stopOnError:!1},h={FORM:"form",OBJECT:"object"},i=function(b,c){var d=a.get(b),e=this;return e._storages={},d?(e.mode=h.FORM,e._init(d,a.merge(g,c))):a.log("[Auth]:form element not exist"),i.superclass.constructor.call(e),e};return a.extend(i,c,{_init:function(b,c){var e=b.elements,g=this;e&&e.length&&a.each(e,function(b){var e=a.merge(c,{event:c.autoBind?f.getEvent(b):"none"}),h=new d(b,e);h.addTarget(g),h.publish("validate",{bubble:1}),g.add(h)}),g.AuthConfig=c,g.mode===h.FORM&&a.one(b).attr("novalidate","novalidate")},add:function(b,c){var e,g,h=this;if(b instanceof d)e=b.get("el"),g=a.one(e).attr("id")||a.one(e).attr("name"),h._storages[g||f.guid()]=b;else if(e=a.one(b)){g=a.one(e).attr("id")||a.one(e).attr("name");var i=a.merge(h.AuthConfig,{event:h.AuthConfig.autoBind?f.getEvent(e):"none"},c);h._storages[g||f.guid()]=new d(e,i)}return h},getField:function(a){return this._storages[a]},register:function(a,b){return e.register(a,b),this},validate:function(){var b=this;b.fire("beforeValidate");var c,d=!0;return a.each(b._storages,function(a){var e=a.validate();return d=d&&e,c=a,b.AuthConfig.stopOnError&&!d?!1:void 0}),b.fire("validate",{result:d,lastField:c}),b.set("result",d),b.fire("afterValidate"),d}},{ATTRS:{result:{}}}),a.mix(i,{Field:d}),i},{requires:["json","base","./field/field","./rule/ruleFactory","./utils"]}),KISSY.add("gallery/auth/1.4/lib/index",function(a,b){return b},{requires:["./base"]}),KISSY.add("gallery/auth/1.4/index",function(a,b){return b},{requires:["./lib/index"]});