/*! auth - v1.4.1 - 2014-02-12 10:58:10 AM
* Copyright (c) 2014 张挺/明河; Licensed  */
KISSY.add("gallery/auth/1.4.1/lib/rule/base",function(a,b){var c={success:"",error:""},d=function(a,b){var c=this;c.validation=a?a:function(){return!0},d.superclass.constructor.call(c),c.set("msg",b)};return a.extend(d,b,{validate:function(){var a=this;return a.validation.apply(a,arguments)}},{ATTRS:{msg:{value:"",setter:function(b){a.isString(b)&&(b={error:b});var d=this.get("msg");return d?a.merge(this.get("msg"),b):a.merge(c,b)}}}}),d},{requires:["base"]}),KISSY.add("gallery/auth/1.4.1/lib/utils",function(S,DOM,undefined){var Utils={toJSON:function(cfg){cfg=cfg.replace(/'/g,'"');try{eval("cfg="+cfg)}catch(e){S.log("data-valid json is invalid")}return cfg},guid:function(){return"AUTH_"+S.guid()},getEvent:function(a){var b="blur",c=DOM.attr(a,"type");switch(c){case"select-multiple":case"radio":case"checkbox":b="click";break;default:b="blur"}return b},getValue:function(a){var b=[],c=DOM.attr(a,"type");switch(c){case"select-multiple":S.each(a.options,function(a){a.selected&&b.push(a.value)});break;case"radio":case"checkbox":S.each(a,function(a){a.checked&&b.push(a.value)});break;default:b=DOM.val(a)}return b},getKeys:function(a){var b=[];for(var c in a)b.push(c);return b}};return Utils},{requires:["dom"]}),KISSY.add("gallery/auth/1.4.1/lib/rule/rule",function(a,b,c){var d=function(a,b,c){var e=this;e._name=a,c=c||{},e._propertyValue=c.propertyValue,e._el=c.el,d.superclass.constructor.call(e,b,c.msg)};return a.extend(d,b,{validate:function(a){var b=this;return b._propertyValue?d.superclass.validate.call(this,b._propertyValue,c.getValue(b._el),a):d.superclass.validate.call(this,c.getValue(b._el),a)}}),d},{requires:["./base","../utils"]}),KISSY.add("gallery/auth/1.4.1/lib/rule/ruleFactory",function(a,b,c,d){var e=function(){var a=this;e.superclass.constructor.call(a)};return e.rules={},a.mix(e.rules,{required:function(b,c){return a.isArray(c)?c.length>0:!!c},pattern:function(a,b){return new RegExp(a).test(b)},max:function(b,c){return a.isNumber(c)?b>=c:!1},min:function(b,c){return a.isNumber(c)?c>=b:!1},step:function(b,c){return a.isNumber(c)?0==c||1==b?!0:c%b:!1},equalTo:function(b,c){return a.isNumber(c)?b===c:a.one(b)?a.one(b).val()===c:b===c}}),a.mix(e,{HTML_PROPERTY:["required","pattern","max","min","step","equalTo"],register:function(a,b){e.rules[a]=b},create:function(b,f){return a.inArray(b,e.HTML_PROPERTY)||e.rules[b]?new c(b,e.rules[b],f):d}}),e},{requires:["base","./rule"]}),KISSY.add("gallery/auth/1.4.1/lib/msg/base",function(a,b){var c="kf-msg",d=function(a,b){var c=this;c._init(a,b),d.superclass.constructor.call(c)};return a.extend(d,b,{_init:function(b,d){var e=this;e._el=a.one(b),e.set("tpl",d.tpl),e.set("args",d.args),e._msgContainer=a.one("."+c,e._el.parent()),e._msgContainer||(e._msgContainer=a.one('<div class="'+c+'" style="display: none"></div>'),e._el.parent().append(e._msgContainer))},hide:function(){this._msgContainer.hide()},show:function(b){var c=this;b=a.merge(c.get("args"),b),a.buffer(function(){c._msgContainer.html(a.substitute(c.get("tpl"),b)),c._msgContainer.show()},50)()}},{ATTRS:{tpl:{value:""},args:{value:{}}}}),d},{requires:["base"]}),KISSY.add("gallery/auth/1.4.1/lib/field/field",function(a,b,c,d,e,f,g,h,i,j){function k(a,b){var c,d=a.get("msg");c=d?b?d[o]:d[p]:b?d[o]:"",a.fire("validate",{result:b,msg:c,name:a._name})}var l="",m="data-valid",n={event:"blur",msg:{style:{success:"ok",error:"error"}},rules:{}},o="success",p="error",q=function(b,c){var d=this;if(d._validateDone={},d._cache={},b&&e.attr(b,m)){var f=e.attr(b,m);f=i.toJSON(f);var g={rules:f};a.mix(c,g,!1,j,!0)}return a.mix(c,n,!1,j,!0),d.set("cfg",c||{}),d._storage={},d._init(b),q.superclass.constructor.call(d),d};return a.extend(q,c,{_init:function(c){var d=this,e=d.get("cfg"),g=a.one(c),j=a.merge({},e.rules);if(a.inArray(g.attr("type"),["checkbox","radio"])){var k=g.getDOMNode().form,l=g.attr("name"),m=[];a.each(document.getElementsByName(l),function(a){a.form==k&&m.push(a)}),d.set("el",m)}else d.set("el",c);e.msg&&(d._msg=new h(g,e.msg)),a.each(f.HTML_PROPERTY,function(a){if(g.hasAttr(a)){var b=f.create(a,{propertyValue:g.attr(a),el:d.get("el"),msg:j[a]});d.add(a,b)}}),a.each(j,function(a,b){if(!d._storage[b]&&f.rules[b]){var c=f.create(b,{el:d.get("el"),msg:a});d.add(b,c)}}),"none"!=e.event&&b.on(d.get("el"),e.event||i.getEvent(g),function(){d.validate()})},add:function(b,c,d){var e=this,h=e._storage;return c instanceof g?h[b]=c:a.isFunction(c)?h[b]=new g(b,c,{el:e._el,msg:d}):(d=c,c=f.create(b,{el:e.get("el"),msg:d}),h[b]=c),h[b]&&h[b].on("validate",function(b){a.log("[after rule validate]: name:"+b.name+",result:"+b.result+",msg:"+b.msg),e._cache[b.name].result=b.result,e._cache[b.name].msg=b.msg}),this._cache[b]={},e},remove:function(a){var b=this._storage;return delete b[a],delete this._cache[a],this},validate:function(b){var c=!0,d=this,e=d._storage,f=l;!function(d,e){function g(){if(l>h&&(!b||b&&b==j[h])){f=d[j[h]];var i=f.validate(function(a){k(f,a),a?(h++,g()):(c=!1,e())});a.isBoolean(i)&&(k(f,i),i?(h++,g()):(c=!1,e()))}else e()}var h=0,j=i.getKeys(d),l=j.length;g()}(e,function(){var a=f&&d._cache[f._name].msg||l;if(d.set("result",c),d.set("msg",a),a){var b=d.get("cfg");d._msg&&d._msg.show({style:c?b.msg.style[o]:b.msg.style[p],msg:a})}else d._msg&&d._msg.hide();d.fire("validate authValidate",{result:c,msg:a,errRule:c?"":f})})},config:function(b){var c=this,d=c.get("cfg");return b?(a.mix(d,b,!0,j,!0),c.set("cfg",d),d.rules&&a.each(d.rules,function(a,b){c._storage[b]?c._storage[b].set("msg",a):c.add(b,a)}),c):d}},{ATTRS:{msg:{value:l},result:{value:!0},el:{},cfg:{}}}),q},{requires:["event","base","json","dom","../rule/ruleFactory","../rule/rule","../msg/base","../utils"]}),KISSY.add("gallery/auth/1.4.1/lib/base",function(a,b,c,d,e,f,g){var h={autoBind:!0,stopOnError:!1,exclude:[]},i=function(b,c){var d=a.get(b),e=this;return e._storages={},d?e._init(d,a.merge(h,c)):a.log("[Auth]:form element not exist"),i.superclass.constructor.call(e),e};return a.extend(i,c,{_init:function(b,c){var d=b.elements,e=this;if(e.set("cfg",c),d&&d.length){var f;a.each(d,function(b){var d=a.one(b),g=d.attr("name"),h=g||d.attr("id");if(!/(hidden|submit|button|reset)/.test(d.attr("type"))&&f!=h&&!a.inArray(g,c.exclude))if(a.inArray(d.attr("type"),["checkbox","radio"])){var i=d.getDOMNode().form,j=[];a.each(document.getElementsByName(g),function(a){a.form==i&&j.push(a)}),e.field(j.pop()),lastName=g}else e.field(d)})}a.one(b).attr("novalidate","novalidate")},field:function(){if(1==arguments.length&&a.isString(arguments[0])&&!a.all(arguments[0]).length)return this._storages[arguments[0]];var b=a.all(arguments[0]),c=arguments[1]||{},e=this,h=e.get("cfg"),i={msg:h.msg,rules:h.rules};return a.each(b,function(b){b=a.one(b);var j=b.attr("id")||b.attr("name");e._storages[j]?e._storages[j].config(c):(a.mix(c,i,!1,g,!0),e._storages[j||f.guid()]=new d(b,a.merge(c,{event:h.autoBind?f.getEvent(b):"none"})))}),e},getField:function(a){return this._storages[a]},register:function(a,b){return e.register(a,b),this},validate:function(a){var b,c=this,d=!0;!function(a,e){function g(){j>h?(b=a[i[h]],b.on("authValidate",function(a){b.detach("authValidate"),h++,a.result?g():(d=!1,c.get("cfg").stopOnError?e():g())}),b.validate()):e()}var h=0,i=f.getKeys(a),j=i.length;g()}(c._storages,function(){c.fire("validate",{result:d,lastField:b}),c.set("result",d),a&&a(d)})}},{ATTRS:{result:{value:!0},cfg:{}}}),i},{requires:["json","base","./field/field","./rule/ruleFactory","./utils"]}),KISSY.add("gallery/auth/1.4.1/index",function(a,b){return b},{requires:["./lib/base"]});